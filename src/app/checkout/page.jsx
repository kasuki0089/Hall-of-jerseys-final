'use client';\n\nimport { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport { useRouter } from 'next/navigation';\n\nexport default function Checkout() {\n  const [carrinho, setCarrinho] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [processando, setProcessando] = useState(false);\n  const [step, setStep] = useState(1); // 1: endereço, 2: pagamento, 3: revisão, 4: confirmação\n  const [mensagem, setMensagem] = useState('');\n  const [enderecos, setEnderecos] = useState([]);\n  const [formasPagamento, setFormasPagamento] = useState([]);\n  const [estados, setEstados] = useState([]);\n  const router = useRouter();\n\n  // Dados do formulário\n  const [dadosCheckout, setDadosCheckout] = useState({\n    enderecoId: null,\n    formaPagamentoId: null,\n    novoEndereco: {\n      endereco: '',\n      numero: '',\n      complemento: '',\n      bairro: '',\n      cidade: '',\n      cep: '',\n      estadoUf: ''\n    },\n    novaFormaPagamento: {\n      tipo: 'cartao_credito',\n      numeroCartao: '',\n      nomeCartao: '',\n      validadeCartao: '',\n      bandeiraCartao: ''\n    }\n  });\n\n  // Simulando usuário logado\n  const usuarioId = 2;\n\n  useEffect(() => {\n    // Carregar dados iniciais\n    const carregarDados = async () => {\n      try {\n        // Carrinho\n        const carrinhoSalvo = localStorage.getItem('carrinho');\n        if (carrinhoSalvo) {\n          setCarrinho(JSON.parse(carrinhoSalvo));\n        }\n\n        // Estados\n        const responseEstados = await fetch('/api/estados');\n        if (responseEstados.ok) {\n          const estadosData = await responseEstados.json();\n          setEstados(estadosData);\n        }\n\n        // Formas de pagamento existentes\n        const responseFormas = await fetch(`/api/formas-pagamento?usuarioId=${usuarioId}`);\n        if (responseFormas.ok) {\n          const formasData = await responseFormas.json();\n          setFormasPagamento(formasData);\n        }\n\n      } catch (error) {\n        console.error('Erro ao carregar dados:', error);\n        setMensagem('Erro ao carregar dados');\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    carregarDados();\n  }, []);\n\n  const calcularTotal = () => {\n    return carrinho.reduce((total, item) => total + item.subtotal, 0);\n  };\n\n  const finalizarPedido = async () => {\n    setProcessando(true);\n    \n    try {\n      const itens = carrinho.map(item => ({\n        produtoId: item.id,\n        quantidade: item.quantidade\n      }));\n\n      const response = await fetch('/api/pedidos', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          usuarioId: usuarioId,\n          itens: itens,\n          formaPagamentoId: dadosCheckout.formaPagamentoId\n        })\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        // Limpar carrinho\n        localStorage.removeItem('carrinho');\n        setCarrinho([]);\n        setStep(4);\n        setMensagem('Pedido realizado com sucesso!');\n      } else {\n        setMensagem(`Erro: ${data.error}`);\n      }\n    } catch (error) {\n      console.error('Erro ao finalizar pedido:', error);\n      setMensagem('Erro ao finalizar pedido');\n    } finally {\n      setProcessando(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-xl\">Carregando checkout...</div>\n      </div>\n    );\n  }\n\n  if (carrinho.length === 0 && step < 4) {\n    return (\n      <div className=\"min-h-screen flex flex-col items-center justify-center\">\n        <div className=\"text-xl mb-4\">Carrinho vazio</div>\n        <p className=\"text-gray-600 mb-6\">Adicione produtos ao carrinho antes de finalizar a compra</p>\n        <Link\n          href=\"/produtos\"\n          className=\"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700\"\n        >\n          Explorar Produtos\n        </Link>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      {/* Navigation */}\n      <nav className=\"bg-white border-b py-4\">\n        <div className=\"max-w-7xl mx-auto px-4\">\n          <div className=\"flex items-center space-x-2 text-sm\">\n            <Link href=\"/\" className=\"text-blue-600 hover:text-blue-800\">\n              Início\n            </Link>\n            <span>›</span>\n            <Link href=\"/produtos\" className=\"text-blue-600 hover:text-blue-800\">\n              Produtos\n            </Link>\n            <span>›</span>\n            <Link href=\"/carrinho\" className=\"text-blue-600 hover:text-blue-800\">\n              Carrinho\n            </Link>\n            <span>›</span>\n            <span className=\"text-gray-500\">Checkout</span>\n          </div>\n        </div>\n      </nav>\n\n      <div className=\"max-w-7xl mx-auto px-4 py-8\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n          {/* Formulário de Checkout */}\n          <div className=\"lg:col-span-2\">\n            <div className=\"bg-white rounded-lg shadow-lg overflow-hidden\">\n              {/* Progress Steps */}\n              <div className=\"bg-blue-600 text-white p-6\">\n                <h1 className=\"text-2xl font-bold mb-4\">Finalizar Compra</h1>\n                <div className=\"flex items-center space-x-4\">\n                  {[\n                    { num: 1, label: 'Endereço' },\n                    { num: 2, label: 'Pagamento' },\n                    { num: 3, label: 'Revisão' },\n                    { num: 4, label: 'Confirmação' }\n                  ].map((stepInfo) => (\n                    <div key={stepInfo.num} className=\"flex items-center\">\n                      <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold ${\n                        step >= stepInfo.num ? 'bg-white text-blue-600' : 'bg-blue-500 text-white'\n                      }`}>\n                        {stepInfo.num}\n                      </div>\n                      <span className=\"ml-2 text-sm\">{stepInfo.label}</span>\n                      {stepInfo.num < 4 && (\n                        <div className=\"w-8 h-0.5 bg-blue-500 ml-4\"></div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {/* Mensagem */}\n              {mensagem && (\n                <div className={`p-4 border-l-4 ${\n                  mensagem.includes('sucesso') || mensagem.includes('✅')\n                    ? 'bg-green-50 border-green-400 text-green-700'\n                    : 'bg-red-50 border-red-400 text-red-700'\n                }`}>\n                  {mensagem}\n                </div>\n              )}\n\n              {/* Step 1: Endereço */}\n              {step === 1 && (\n                <div className=\"p-6\">\n                  <h2 className=\"text-xl font-semibold mb-4\">Endereço de Entrega</h2>\n                  \n                  {/* TODO: Lista de endereços existentes */}\n                  <div className=\"space-y-4\">\n                    <h3 className=\"font-medium\">Novo Endereço</h3>\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <div className=\"md:col-span-2\">\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Endereço *\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novoEndereco.endereco}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, endereco: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"Rua das Flores\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Número *\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novoEndereco.numero}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, numero: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"123\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Complemento\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novoEndereco.complemento}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, complemento: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"Apto 45\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Bairro *\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novoEndereco.bairro}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, bairro: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"Centro\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Cidade *\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novoEndereco.cidade}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, cidade: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"São Paulo\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          CEP *\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novoEndereco.cep}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, cep: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"01234-567\"\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Estado *\n                        </label>\n                        <select\n                          value={dadosCheckout.novoEndereco.estadoUf}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novoEndereco: { ...dadosCheckout.novoEndereco, estadoUf: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                        >\n                          <option value=\"\">Selecione...</option>\n                          {estados.map(estado => (\n                            <option key={estado.uf} value={estado.uf}>\n                              {estado.nome} ({estado.uf})\n                            </option>\n                          ))}\n                        </select>\n                      </div>\n                    </div>\n                    \n                    <button\n                      onClick={() => setStep(2)}\n                      disabled={!dadosCheckout.novoEndereco.endereco || !dadosCheckout.novoEndereco.numero || !dadosCheckout.novoEndereco.bairro || !dadosCheckout.novoEndereco.cidade || !dadosCheckout.novoEndereco.cep || !dadosCheckout.novoEndereco.estadoUf}\n                      className=\"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400\"\n                    >\n                      Continuar para Pagamento →\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Step 2: Pagamento */}\n              {step === 2 && (\n                <div className=\"p-6\">\n                  <h2 className=\"text-xl font-semibold mb-4\">Forma de Pagamento</h2>\n                  \n                  {/* Formas existentes */}\n                  {formasPagamento.length > 0 && (\n                    <div className=\"mb-6\">\n                      <h3 className=\"font-medium mb-3\">Formas Cadastradas</h3>\n                      <div className=\"space-y-2\">\n                        {formasPagamento.map(forma => (\n                          <label key={forma.id} className=\"flex items-center space-x-3 p-3 border rounded hover:bg-gray-50 cursor-pointer\">\n                            <input\n                              type=\"radio\"\n                              name=\"formaPagamento\"\n                              value={forma.id}\n                              checked={dadosCheckout.formaPagamentoId === forma.id}\n                              onChange={(e) => setDadosCheckout({\n                                ...dadosCheckout,\n                                formaPagamentoId: parseInt(e.target.value)\n                              })}\n                            />\n                            <div>\n                              <p className=\"font-medium\">{forma.numeroCartao}</p>\n                              <p className=\"text-sm text-gray-600\">\n                                {forma.bandeiraCartao} - {forma.tipo === 'cartao_credito' ? 'Crédito' : 'Débito'}\n                              </p>\n                            </div>\n                          </label>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                  \n                  {/* Nova forma de pagamento */}\n                  <div className=\"space-y-4\">\n                    <h3 className=\"font-medium\">Nova Forma de Pagamento</h3>\n                    <div className=\"space-y-4\">\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Tipo de Cartão\n                        </label>\n                        <select\n                          value={dadosCheckout.novaFormaPagamento.tipo}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novaFormaPagamento: { ...dadosCheckout.novaFormaPagamento, tipo: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                        >\n                          <option value=\"cartao_credito\">Cartão de Crédito</option>\n                          <option value=\"cartao_debito\">Cartão de Débito</option>\n                        </select>\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Número do Cartão\n                        </label>\n                        <input\n                          type=\"text\"\n                          value={dadosCheckout.novaFormaPagamento.numeroCartao}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novaFormaPagamento: { ...dadosCheckout.novaFormaPagamento, numeroCartao: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                          placeholder=\"1234 5678 9012 3456\"\n                        />\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div>\n                          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                            Nome no Cartão\n                          </label>\n                          <input\n                            type=\"text\"\n                            value={dadosCheckout.novaFormaPagamento.nomeCartao}\n                            onChange={(e) => setDadosCheckout({\n                              ...dadosCheckout,\n                              novaFormaPagamento: { ...dadosCheckout.novaFormaPagamento, nomeCartao: e.target.value }\n                            })}\n                            className=\"w-full p-2 border rounded\"\n                            placeholder=\"João Silva\"\n                          />\n                        </div>\n                        <div>\n                          <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                            Validade\n                          </label>\n                          <input\n                            type=\"text\"\n                            value={dadosCheckout.novaFormaPagamento.validadeCartao}\n                            onChange={(e) => setDadosCheckout({\n                              ...dadosCheckout,\n                              novaFormaPagamento: { ...dadosCheckout.novaFormaPagamento, validadeCartao: e.target.value }\n                            })}\n                            className=\"w-full p-2 border rounded\"\n                            placeholder=\"12/2025\"\n                          />\n                        </div>\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                          Bandeira\n                        </label>\n                        <select\n                          value={dadosCheckout.novaFormaPagamento.bandeiraCartao}\n                          onChange={(e) => setDadosCheckout({\n                            ...dadosCheckout,\n                            novaFormaPagamento: { ...dadosCheckout.novaFormaPagamento, bandeiraCartao: e.target.value }\n                          })}\n                          className=\"w-full p-2 border rounded\"\n                        >\n                          <option value=\"\">Selecione...</option>\n                          <option value=\"Visa\">Visa</option>\n                          <option value=\"Mastercard\">Mastercard</option>\n                          <option value=\"Elo\">Elo</option>\n                          <option value=\"American Express\">American Express</option>\n                        </select>\n                      </div>\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex space-x-4 mt-6\">\n                    <button\n                      onClick={() => setStep(1)}\n                      className=\"bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300\"\n                    >\n                      ← Voltar\n                    </button>\n                    <button\n                      onClick={() => setStep(3)}\n                      disabled={!dadosCheckout.formaPagamentoId && (!dadosCheckout.novaFormaPagamento.numeroCartao || !dadosCheckout.novaFormaPagamento.nomeCartao)}\n                      className=\"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400\"\n                    >\n                      Continuar para Revisão →\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* Step 3: Revisão */}\n              {step === 3 && (\n                <div className=\"p-6\">\n                  <h2 className=\"text-xl font-semibold mb-4\">Revisão do Pedido</h2>\n                  \n                  <div className=\"space-y-6\">\n                    {/* Endereço */}\n                    <div>\n                      <h3 className=\"font-medium mb-2\">Endereço de Entrega</h3>\n                      <div className=\"bg-gray-50 p-3 rounded\">\n                        <p>{dadosCheckout.novoEndereco.endereco}, {dadosCheckout.novoEndereco.numero}</p>\n                        {dadosCheckout.novoEndereco.complemento && (\n                          <p>{dadosCheckout.novoEndereco.complemento}</p>\n                        )}\n                        <p>{dadosCheckout.novoEndereco.bairro}</p>\n                        <p>{dadosCheckout.novoEndereco.cidade} - {dadosCheckout.novoEndereco.estadoUf}</p>\n                        <p>CEP: {dadosCheckout.novoEndereco.cep}</p>\n                      </div>\n                    </div>\n\n                    {/* Forma de Pagamento */}\n                    <div>\n                      <h3 className=\"font-medium mb-2\">Forma de Pagamento</h3>\n                      <div className=\"bg-gray-50 p-3 rounded\">\n                        {dadosCheckout.formaPagamentoId ? (\n                          <p>Cartão cadastrado selecionado</p>\n                        ) : (\n                          <div>\n                            <p>{dadosCheckout.novaFormaPagamento.bandeiraCartao} {dadosCheckout.novaFormaPagamento.tipo === 'cartao_credito' ? 'Crédito' : 'Débito'}</p>\n                            <p>Terminado em {dadosCheckout.novaFormaPagamento.numeroCartao.slice(-4)}</p>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex space-x-4\">\n                      <button\n                        onClick={() => setStep(2)}\n                        className=\"bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300\"\n                      >\n                        ← Voltar\n                      </button>\n                      <button\n                        onClick={finalizarPedido}\n                        disabled={processando}\n                        className=\"bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 disabled:bg-gray-400\"\n                      >\n                        {processando ? 'Processando...' : 'Finalizar Pedido'}\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Step 4: Confirmação */}\n              {step === 4 && (\n                <div className=\"p-6 text-center\">\n                  <div className=\"mb-6\">\n                    <svg className=\"mx-auto h-16 w-16 text-green-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                    </svg>\n                  </div>\n                  <h2 className=\"text-2xl font-bold text-green-600 mb-2\">Pedido Realizado!</h2>\n                  <p className=\"text-gray-600 mb-6\">Seu pedido foi processado com sucesso</p>\n                  \n                  <div className=\"flex justify-center space-x-4\">\n                    <Link\n                      href=\"/produtos\"\n                      className=\"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700\"\n                    >\n                      Continuar Comprando\n                    </Link>\n                    <Link\n                      href=\"/perfil\"\n                      className=\"bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700\"\n                    >\n                      Ver Meus Pedidos\n                    </Link>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Resumo do Pedido */}\n          {step < 4 && (\n            <div className=\"bg-white rounded-lg shadow-lg p-6 h-fit\">\n              <h3 className=\"text-lg font-semibold mb-4\">Resumo do Pedido</h3>\n              \n              <div className=\"space-y-3\">\n                {carrinho.map(item => (\n                  <div key={item.id} className=\"flex justify-between text-sm\">\n                    <div>\n                      <p className=\"font-medium\">{item.nome}</p>\n                      <p className=\"text-gray-600\">Qtd: {item.quantidade}</p>\n                    </div>\n                    <p className=\"font-medium\">R$ {item.subtotal.toFixed(2)}</p>\n                  </div>\n                ))}\n              </div>\n              \n              <div className=\"border-t mt-4 pt-4\">\n                <div className=\"flex justify-between text-lg font-semibold\">\n                  <span>Total:</span>\n                  <span>R$ {calcularTotal().toFixed(2)}</span>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n"