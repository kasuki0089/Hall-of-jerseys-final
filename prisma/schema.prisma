// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Tabela de Estados
model Estado {
  uf        String     @id
  nome      String
  enderecos Endereco[]

  @@map("estados")
}

// Tabela de Endereços  
model Endereco {
  id          Int       @id @default(autoincrement())
  endereco    String
  numero      String
  complemento String?
  bairro      String
  cidade      String
  cep         String
  estado      Estado    @relation(fields: [estadoUf], references: [uf])
  estadoUf    String
  usuarios    Usuario[]

  @@map("enderecos")
}

// Tabela de Cores
model Cor {
  id       Int       @id @default(autoincrement())
  nome     String    @unique
  codigo   String? // Para hex colors #FFFFFF
  produtos Produto[]

  @@map("cores")
}

// Tabela de Tamanhos
model Tamanho {
  id       Int       @id @default(autoincrement())
  nome     String    @unique // PP, P, M, G, GG, XGG
  ordem    Int       @unique // Para ordenação (1=PP, 2=P, etc)
  produtos Produto[]

  @@map("tamanhos")
}

// Tabela de Formas de Pagamento
model FormaPagamento {
  id             Int      @id @default(autoincrement())
  tipo           String   // 'cartao_credito', 'cartao_debito', 'pix', 'boleto'
  numeroCartao   String?  // Apenas últimos 4 dígitos para segurança
  nomeCartao     String?
  validadeCartao String?  // MM/YYYY
  bandeiraCartao String?  // Visa, Mastercard, etc
  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId      Int
  ativo          Boolean  @default(true)
  criadoEm       DateTime @default(now())
  pedidos        Pedido[]

  @@map("formas_pagamento")
}

model Liga {
  id       Int       @id @default(autoincrement())
  nome     String    @unique
  sigla    String    @unique
  times    Time[]
  produtos Produto[]

  @@map("ligas")
}

model Time {
  id       Int       @id @default(autoincrement())
  nome     String
  sigla    String
  cidade   String
  liga     Liga      @relation(fields: [ligaId], references: [id])
  ligaId   Int
  produtos Produto[]

  @@map("times")
}

model Produto {
  id                  Int                   @id @default(autoincrement())
  nome                String
  codigo              String                @unique
  descricao           String?
  modelo              String                // Ex: "Jersey Home", "Jersey Away", "Regata", etc
  preco               Float
  year                Int
  serie               String?               // Home, Away, Third, Special Edition
  estoque             Int                   @default(0)
  ativo               Boolean               @default(true)
  sale                Boolean               @default(false)
  imagemUrl           String?
  criadoEm            DateTime              @default(now())
  atualizadoEm        DateTime              @updatedAt
  liga                Liga                  @relation(fields: [ligaId], references: [id])
  ligaId              Int
  time                Time?                 @relation(fields: [timeId], references: [id])
  timeId              Int?
  cor                 Cor                   @relation(fields: [corId], references: [id])
  corId               Int
  tamanho             Tamanho               @relation(fields: [tamanhoId], references: [id])
  tamanhoId           Int
  itensPedido         ItemPedido[]
  configuracaoEstoque ConfiguracaoEstoque?
  movimentacoesEstoque MovimentacaoEstoque[]
  avaliacoes          Avaliacao[]

  @@map("produtos")
}

// Tabela de Configuração de Estoque por Produto
model ConfiguracaoEstoque {
  id                    Int      @id @default(autoincrement())
  produtoId             Int      @unique
  quantidadeMinima      Int      @default(5)    // Alerta de estoque baixo
  quantidadeMaxima      Int      @default(100)  // Limite de estoque
  pontoReposicao        Int      @default(10)   // Quando atingir, criar alerta de reposição
  tempoMedioReposicao   Int?                    // Em dias
  fornecedor            String?                 // Nome do fornecedor principal
  custoUltimaCompra     Float?                  // Custo da última compra
  dataUltimaCompra      DateTime?               // Data da última compra
  observacoes           String?
  produto               Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  criadoEm              DateTime @default(now())
  atualizadoEm          DateTime @updatedAt

  @@map("configuracoes_estoque")
}

// Tabela de Movimentação de Estoque (Histórico)
model MovimentacaoEstoque {
  id                Int      @id @default(autoincrement())
  produtoId         Int
  tipo              String   // ENTRADA, SAIDA, AJUSTE, DEVOLUCAO
  quantidade        Int      // Positivo para entrada, negativo para saída
  quantidadeAntes   Int      // Estoque antes da movimentação
  quantidadeDepois  Int      // Estoque depois da movimentação
  motivo            String?  // Compra, Venda, Ajuste de inventário, etc
  custo             Float?   // Custo unitário (para entradas)
  valorTotal        Float?   // Quantidade * Custo
  fornecedor        String?  // Para entradas
  notaFiscal        String?  // Número da NF
  responsavel       String?  // Quem fez a movimentação
  observacoes       String?
  produto           Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  criadoEm          DateTime @default(now())

  @@index([produtoId])
  @@index([tipo])
  @@index([criadoEm])
  @@map("movimentacoes_estoque")
}

model Usuario {
  id               Int               @id @default(autoincrement())
  nome             String
  email            String            @unique
  senha            String
  telefone         String?
  role             String            @default("user") // user, admin
  criadoEm         DateTime          @default(now())
  atualizadoEm     DateTime          @updatedAt
  endereco         Endereco?         @relation(fields: [enderecoId], references: [id])
  enderecoId       Int?
  formasPagamento  FormaPagamento[]
  pedidos          Pedido[]
  avaliacoes       Avaliacao[]

  @@map("usuarios")
}

model Pedido {
  id               Int             @id @default(autoincrement())
  usuarioId        Int
  total            Float
  status           String          @default("pendente") // pendente, processando, enviado, entregue, cancelado
  criadoEm         DateTime        @default(now())
  atualizadoEm     DateTime        @updatedAt
  confirmadoEm     DateTime?
  transacaoId      String?         @unique
  usuario          Usuario         @relation(fields: [usuarioId], references: [id])
  formaPagamento   FormaPagamento? @relation(fields: [formaPagamentoId], references: [id])
  formaPagamentoId Int?
  itens            ItemPedido[]
  transacao        Transacao?      @relation(fields: [transacaoId], references: [id])

  @@map("pedidos")
}

model ItemPedido {
  id         Int      @id @default(autoincrement())
  pedidoId   Int
  produtoId  Int
  quantidade Int
  preco      Float
  criadoEm   DateTime @default(now())
  pedido     Pedido   @relation(fields: [pedidoId], references: [id])
  produto    Produto  @relation(fields: [produtoId], references: [id])

  @@map("itens_pedido")
}

model Transacao {
  id            String    @id
  pedidoId      Int
  tipo          String    // PIX, CARTAO, BOLETO
  valor         Float
  status        String    // PENDENTE, APROVADO, REJEITADO, CANCELADO
  dadosGateway  String?   // JSON com dados do gateway
  erro          String?
  processadoEm  DateTime  @default(now())
  pedido        Pedido?

  @@map("transacoes")
}

model Avaliacao {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  produtoId  Int
  nota       Float    // 1.0 a 5.0
  comentario String?  @db.Text
  criadoEm   DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  produto    Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, produtoId]) // Um usuário pode avaliar cada produto apenas uma vez
  @@index([produtoId])
  @@index([nota])
  @@map("avaliacoes")
}
